name: Build and Release

on:
  push:
    branches:
      - main  # 指定触发分支，可改为你的分支名
      - develop  # 可添加多个分支
    tags:
      - v*  # 当推送标签时触发（例如 v1.0.0）

jobs:
  # 构建作业：在所有平台上构建
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    env:
      CI: true  # 启用持续集成模式（大多数工具默认支持）
      DEBIAN_FRONTEND: noninteractive  # 适用于 apt-get（Linux）
      ACCEPT_EULA: Y  # 接受 Microsoft 软件许可协议
      npm_config_yes: true  # npm 命令默认回答 "yes"
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm i

      - name: Eslint
        if: runner.os == 'Windows'
        run: npm run lint

      - name: Build app
        run: npm run electron:build

      # 获取构建产物文件名（跨平台兼容）
      - name: Get artifact filename
        id: get_artifact
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            # Windows 平台：查找 .exe 文件
            artifact_path=$(find dist_electron -name "*.exe" -type f | head -1)
            if [[ -z "$artifact_path" ]]; then
              echo "No .exe file found in dist_electron"
              exit 1
            fi
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            # macOS 平台：查找 .dmg 文件，没有则查找 .zip 文件
            artifact_path=$(find dist_electron -name "*.dmg" -type f | head -1)
            if [[ -z "$artifact_path" ]]; then
              artifact_path=$(find dist_electron -name "*.zip" -type f | head -1)
              if [[ -z "$artifact_path" ]]; then
                echo "No .dmg or .zip file found in dist_electron"
                exit 1
              fi
            fi
          elif [[ "$RUNNER_OS" == "Linux" ]]; then
            # Linux 平台：查找 .AppImage 文件，没有则查找 .snap 文件，最后查找 .deb 文件
            artifact_path=$(find dist_electron -name "*.AppImage" -type f | head -1)
            if [[ -z "$artifact_path" ]]; then
              artifact_path=$(find dist_electron -name "*.snap" -type f | head -1)
              if [[ -z "$artifact_path" ]]; then
                artifact_path=$(find dist_electron -name "*.deb" -type f | head -1)
                if [[ -z "$artifact_path" ]]; then
                  echo "No .AppImage, .snap, or .deb file found in dist_electron"
                  exit 1
                fi
              fi
            fi
          fi
          
          # 提取文件名
          artifact_name=$(basename "$artifact_path")
          
          # 设置环境变量
          echo "ARTIFACT_PATH=$artifact_path" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=$artifact_name" >> $GITHUB_ENV
          
          echo "Found artifact: $artifact_name at $artifact_path"
        shell: bash

      # 上传构建产物作为 Artifact（用于后续发布步骤）
      - name: Upload Build Artifact
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact-${{ matrix.os }}
          path: ${{ env.ARTIFACT_PATH }}
          compression-level: 0

  # 发布作业：在所有构建完成后，创建 Release 并上传所有资产
  release:
    needs: build  # 依赖于 build 作业完成
    runs-on: ubuntu-latest  # 在 Ubuntu 上运行发布作业
    if: startsWith(github.ref, 'refs/tags/')  # 只在推送标签时运行
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 下载所有平台的构建产物
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # 创建 GitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

      # 获取各平台构建产物文件名
      - name: Get artifact filenames
        id: get_filenames
        shell: bash
        run: |
          # 获取 Windows 构建产物文件名
          WINDOWS_FILE=$(ls -la artifacts/build-artifact-windows-latest/ | grep \.exe | head -1 | awk "{print $9}")
          echo "WINDOWS_FILE=$WINDOWS_FILE" >> $GITHUB_ENV
          echo "WINDOWS_PATH=artifacts/build-artifact-windows-latest/$WINDOWS_FILE" >> $GITHUB_ENV
          
          # 获取 macOS 构建产物文件名
          MACOS_FILE=$(ls -la artifacts/build-artifact-macos-latest/ | grep -E "\.(dmg|zip)$" | head -1 | awk "{print $9}")
          echo "MACOS_FILE=$MACOS_FILE" >> $GITHUB_ENV
          echo "MACOS_PATH=artifacts/build-artifact-macos-latest/$MACOS_FILE" >> $GITHUB_ENV
          
          # 获取 macOS 构建产物的 MIME 类型
          if [[ "$MACOS_FILE" == *.dmg ]]; then
            echo "MACOS_CONTENT_TYPE=application/x-apple-diskimage" >> $GITHUB_ENV
          elif [[ "$MACOS_FILE" == *.zip ]]; then
            echo "MACOS_CONTENT_TYPE=application/zip" >> $GITHUB_ENV
          else
            echo "MACOS_CONTENT_TYPE=application/octet-stream" >> $GITHUB_ENV
          fi
          
          # 获取 Linux 构建产物文件名
          LINUX_FILE=$(ls -la artifacts/build-artifact-ubuntu-latest/ | grep -E "\.(AppImage|snap|deb)$" | head -1 | awk "{print $9}")
          echo "LINUX_FILE=$LINUX_FILE" >> $GITHUB_ENV
          echo "LINUX_PATH=artifacts/build-artifact-ubuntu-latest/$LINUX_FILE" >> $GITHUB_ENV
          
          # 获取 Linux 构建产物的 MIME 类型
          if [[ "$LINUX_FILE" == *.AppImage ]]; then
            echo "LINUX_CONTENT_TYPE=application/x-appimage" >> $GITHUB_ENV
          elif [[ "$LINUX_FILE" == *.snap ]]; then
            echo "LINUX_CONTENT_TYPE=application/x-snap" >> $GITHUB_ENV
          elif [[ "$LINUX_FILE" == *.deb ]]; then
            echo "LINUX_CONTENT_TYPE=application/vnd.debian.binary-package" >> $GITHUB_ENV
          else
            echo "LINUX_CONTENT_TYPE=application/octet-stream" >> $GITHUB_ENV
          fi
          
          echo "Windows file: $WINDOWS_FILE"
          echo "macOS file: $MACOS_FILE"
          echo "Linux file: $LINUX_FILE"

      # 上传 Windows 构建产物
      - name: Upload Windows Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.WINDOWS_PATH }}
          asset_name: ${{ env.WINDOWS_FILE }}
          asset_content_type: application/octet-stream

      # 上传 macOS 构建产物
      - name: Upload macOS Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.MACOS_PATH }}
          asset_name: ${{ env.MACOS_FILE }}
          asset_content_type: ${{ env.MACOS_CONTENT_TYPE }}

      # 上传 Linux 构建产物
      - name: Upload Linux Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.LINUX_PATH }}
          asset_name: ${{ env.LINUX_FILE }}
          asset_content_type: ${{ env.LINUX_CONTENT_TYPE }}
